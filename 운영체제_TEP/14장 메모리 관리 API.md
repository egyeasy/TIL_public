# 14. 메모리 관리 API

핵심 질문: 어떻게 메모리를 할당하고 관리해야 하는가

## 14.1 메모리 공간의 종류

1. **스택**
   할당과 반환은 프로그래머를 위해 컴파일러에 의해 암묵적으로 이루어진다. -> 자동 메모리

   함수 내의 변수를 선언함으로써 공간이 확보된다.

2. **힙**

   오랫 동안 값이 유지되어야 하는 변수를 위한 공간.

   할당관 반환이 프로그래머에 의해 명시적으로 처리됨.

   ```c
   void func() {
       int *x = (int *) malloc(sizeof(int));
   }
   ```



## 14.2 malloc() 함수

힙에 요청할 공간의 크기를 넘겨주면, 성공했을 경우 새로 할당된 공간에 대한 포인터를 반환하고 실패했을 경우 NULL을 반환하는 함수

stdlib.h를 include 해야 함.

sizeof - 인자의 실제크기가 컴파일 시간에 결정되게 하는 컴파일 시간 연산자.



### 주의할 점

- 문자열을 다룰 때에는 malloc(strlen(s) + 1)과 같은 식으로 문자열 끝 공간을 포함해서 할당해야 한다.
- malloc은 void 타입 포인터를 반환한다 -> 사용자가 타입 변환을 통해 공간 활용 방식을 결정해야 한다.



## 14.3 free() 함수

할당한 메모리를 언제, 어떻게 할당하고 해제 여부를 확인하는 것이 더 어려운 문제이다.

```c
int *x = malloc(10 * sizeof(int));
free(x);
```

할당된 메모리의 크기는 메모리 할당 라이브러리가 알고 있으므로 할당된 영역의 크기는 전달되지 않는다.



## 14.4 흔한 오류

### 메모리 할당 잊어버리기

```c
char *src = "hello";
char *dst;		// 할당을 하지 않음
strcpy(dst, src);
```

-> 세그멘테이션 fault 유발(메모리 관련한 잘못)



### 메모리를 부족하게 할당받기

```c
char *src = "hello";
char *dst = (char *) malloc(strlen(src));
strcpy(dst, src);
```

문자열 복사가 실행될 때 할당된 공간의 마지막을 지나쳐 한 바이트 만큼 공간을 더 사용한다.

-> 잘 동작할 때도 있고, 아니면 고장나거나 크래시 된다.



### 할당 받은 메모리 초기화 하지 않기

특정 값을 넣는 것을 잊는 문제 -> 초기화되지 않은 읽기(uninitialized read). 임의의 값 or 해로운 값이 읽힐 것



### 메모리 해제하지 않기

**메모리 누수** ->  프로세스가 종료될 경우 운영체제가 할당된 메모리를 회수하기 때문에 누수된 것을 찾아올 수 있다.

하지만 장시간 실행되는 서버(웹서버나 DBMS)나 운영체제의 경우에선 큰 문제가 될 수 있다.



### 메모리 사용이 끝나기 전에 메모리 해제하기

-> dangling pointer -> 이미 해제된 포인터를 사용하면 크래시 되거나 유효 메모리 영역을 덮어쓸 수 있다.



### 반복적으로 메모리 해제하기

메모리를 한 번 이상 해제 -> 이중 해제(double free) -> 예측할 수 없는 결과 발생



### free() 잘못 호출하기

malloc() 받은 포인터 이외의 값을 free()에 전달하면 문제가 발생한다 = 유효하지 않은 해제(**invalid frees**)



## 14.5 운영체제의 지원

메모리 관리 라이브러리는 시스템에게 더 많은 메모리를 요구하고 반환하는 시스템 콜을 기반으로 구축된다.

**brk** - 프로그램의 break 위치(힙의 마지막 위치)를 변경하는 데 사용됨. 새로운 break가 현재 break보다 큰지 작은지에 따라 힙의 크기가 증가 or 감소. sbrk는 증가분을 전달받음.

brk나 sbrk를 직접 호출하지 마라.

mmap() - 운영체제로부터 직접 메모리를 얻을 수 있다.(프로그램의 anonymous 메모리 영역 확보 - 특정 파일과 연결되어있지 않고 스왑 공간(swap space)에 연결된 영역)



## 14.6 기타 함수들

calloc() - 메모리를 할당 영역을 0으로 채워서 반환.

realloc() - 이미 할당된 공간에 대해 추가 공간 할당