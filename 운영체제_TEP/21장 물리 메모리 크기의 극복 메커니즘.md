# 21. 물리 메모리 크기의 극복 : 메커니즘

다수의 프로세스들이 동시에 각자 큰 주소 공간을 사용하고 있어서

가상 주소 공간을 모두 물리 메모리에 탑재 가능한 것이 아니라면?



**핵심 질문 : 물리 메모리 이상으로 나아가기 위해서 어떻게 할까**



### 프로세스에게 큰 주소 공간을 제공해야 하는 이유

1. 편리함
2. 사용 용이성
3. 멀티프로그래밍 시스템의 도입 - 동시에 여러 프로그램을 실행시키는 시스템

스왑 공간 -> 운영체제는 프로세스들에게 큰 가상 메모리가 있는 것 같은 환상을 주게 된다.



## 21.1 스왑 공간

페이지를 저장하기 위해 디스크에 확보된 공간

Swap in - 디스크 스왑 공간에서 페이지를 읽어 메모리에 탑재

swap out - 메모리 페이지를 읽어서 스왑 공간에 쓰기

이를 통해 프로세스는 몇 개의 유효한 페이지들만 메모리에 올려놓을 수 있다.



## 21.2 Present Bit

### 페이지 스왑 기능의 작동 순서

하드웨어 기반의 TLB 시스템 가정

1. 프로세스가 가상 메모리 참조 생성
2. 하드웨어는 가상 주소를 물리 주소로 변환
   1. 가상주소에서 VPN 추출 후에 TLB에 해당 정보 있는지 검사
      - 있다면(TLB 히트) 물리 주소를 얻은 후에 메모리로 가져옴
      - 없다면(TLB 미스)
        1. 하드웨어는 페이지 테이블의 메모리 주소 파악(페이지 테이블 베이스 레지스터 사용)
        2. VPN을 index로 원하는 페이지 테이블 항목(PTE)를 추출
        3. PTE가 유효하고, **페이지가 물리 메모리에 존재하면** 하드웨어는 PTE에서 PFN 정보를 추출 -> 정보를 TLB에 탑재
        4. 명령어 재실행



### present bit

PTE에서 페이지가 물리 메모리에 존재하지 않는다는 것을 표현

1 - 해당 페이지 존재

0 - 존재 x(page fault) -> 운영체제로 제어권이 넘어가 페이지 폴트 핸들러 실행



## 21.3 페이지 폴트

페이지 폴트가 발생하면 운영체제가 그 처리를 담당한다.

### page fault handler

1. 요청된 페이지가 메모리에 없고 디스크로 스왑되었다면

2. 운영체제는 해당 페이지를 메모리로 스왑해온다.

그렇다면

원하는 페이지의 위치를 어떻게 파악할까? -> 페이지 테이블에 해당 페이지의 스왑 공간상에서의 위치를 저장.

PFN과 같은 PTE의 비트를 페이지의 디스크 주소를 나타내는 데 사용 가능.



3. 디스크 I/O 완료 후 운영체제는 PTE의 PFN 값을 탑재된 페이지의 메모리 위치로 갱신

4. 페이지 폴트를 발생시킨 명령어 재실행



유의할 점  - I/O 전송 중에는 해당 프로세스가 차단된(blocked) 상태가 된다.

그동안 다른 프로세스를 실행하는 것을 중첩(overlap)이라 한다. -> 하드웨어를 최대한 효율적으로 사용



## 21.4 메모리에 빈 공간이 없으면?

새로운 페이지들을 위한 공간을 확보하기 위해 기존 페이지들을 page out한다(**페이지 교체 정책**에 따라).



## 21.5 페이지 폴트의 처리

하드웨어 처리 과정에서 TLB 미스 발생 시 3가지 경우가 발생한다.

1. 페이지가 존재하며 유효한 경우

   TLB 미스 핸들러가 PTE에서 PFN을 가져와서 명령어를 재시도

2. 페이지가 유효하지만 존재하지 않는 경우

   페이지 폴트 핸들러 실행

3. 페이지가 유효하지 않는 경우

   잘못된 주소 접근하는 경우의 처리(segmentation fault)



운영체제가 페이지 폴트를 처리하는 과정

1. 탑재할 페이지를 위한 물리 프레임 확보
2. 여유 프레임이 없다면 교체 알고리즘을 실행하여 여유 공간 확보
3. 물리 프레임 확보 후 I/O 요청하여 스왑 영역에서 페이지를 읽어온다.
4. 페이지 테이블을 갱신하고 명령어를 재시도



## 21.6 교체는 언제 일어나는가

메모리에 여유 공간이 고갈된 후에 교체 알고리즘이 작동하는 방식은 그리 효율적이지 않다.

-> 여유 공간에 관련된 최댓값(high watermark, HW)과 최솟값(low watermark, LW)을 설정

-> 메모리에 항상 어느 정도의 여유 공간 확보



### 동작 방식

1. 여유 공간의 크기가 최솟값보다 작아지면 운영체제는 백그라운드 쓰레드 실행
2. **스왑 데몬** 혹은 **페이지 데몬** 에 해당하는 백그라운드 쓰레드는 여유 공간의 크기가 최댓값에 이를 때까지 페이지를 제거



### 성능 개선

여러 개를 교체할 경우 성능 개선이 가능

다수의 페이지를 클러스터나 그룹으로 묶어서 스왑 파티션에 저장 -> 디스크 효율을 높인다(탐색과 회전 지연의 오버헤드 경감)

